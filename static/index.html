<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Live Code</title>

    <style>
        body, button {
            margin: 0;
            padding: 0;
        }

        button {
            display: inline-flex;
            padding: 2px 4px;
        }

        main {
            width: 100vw;
            height: 100vh;
            display: flex;
        }

        #left, #right {
            width: 50%;
            overflow-y: auto;
        }

        .gutter {
            background: #eee;
        }

        #editor, .cm-editor {
            height: 100%;
        }

        #left {
            position: relative;
        }

        #left .btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>

    <script src="//storage.360buyimg.com/dest/lzutf8.min.js"></script>
    <script>
        function compressText(str) { return LZUTF8.compress(str, {outputEncoding: "Base64"}) }
        function decompressText(str) { return LZUTF8.decompress(str, {inputEncoding: "Base64"}) }
    </script>
    <script src="//storage.360buyimg.com/dest/split.min.js"></script>
    <script src="//storage.360buyimg.com/dest/react.production.min.js"></script>
    <script src="//storage.360buyimg.com/dest/react-dom.production.min.js"></script>
    <script src="codemirror-editor.js"></script>
</head>
<body>

<main>
    <div id="left">
        <div id="editor"></div>
        <div class="btn">
            <button onclick="lc.handleShare()">
                <svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186a2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185a2.25 2.25 0 0 0-3.933 2.185Z"/>
                </svg>
            </button>
            <button onclick="lc.handleFormat()">
                <svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5"/>
                </svg>
            </button>
        </div>
    </div>
    <div id="right">
        <iframe src="/preview" id="preview" width="100%" height="100%" frameborder="0"></iframe>
    </div>
</main>

<script>
    (function (lc) {
        const getCode = function(code) {
            return code || lc.editor.state.doc.toString()
        }
        const iframe = document.getElementById('preview')

        lc.handleChange = (content) => {
            lc.build(getCode(content), ({data, error}) => {
                if (error) {
                    console.error(error)
                } else {
                    writeIframeContent(data)
                }
            })
        }
        lc.handleFormat = (content) => {
            lc.format(getCode(content), ({data, error}) => {
                if (error) {
                    console.error(error)
                } else {
                    lc.editor.setContent(data)
                }
            })
        }
        lc.handleShare = (content) => {
            const url = location.origin + "/preview?code=" +
                encodeURIComponent(compressText(getCode(content)));
            const yes = window.prompt(
                "按确认将复制下面的 URL 并在新页面打开：",
                url,
            );
            if (yes) {
                window.open(url);
            }

        }

        lc.debounce = function (func, wait, immediate) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;

                const later = function () {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };

                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        }

        lc.format = (code, callback) => {
            fetch('/api/format', {
                method: 'POST',
                body: JSON.stringify({
                    code,
                })
            })
                .then(res => res.json())
                .then(callback).catch(console.error)
        }
        lc.build = (code, callback) => {
            fetch('/api/build', {
                method: 'POST',
                body: JSON.stringify({code})
            })
                .then(res => res.json())
                .then(callback).catch(console.error)
        }

        const writeIframeContent = (content) => {
            const win = iframe.contentWindow;
            const doc = iframe.contentDocument || win.document;
            const get = (id) => doc.getElementById(id);

            win._REACT_ROOT_?.unmount();
            get('script')?.remove();

            const script = doc.createElement('script');
            script.id = 'script';
            script.textContent = content;

            doc.body.appendChild(script);
        };

        iframe.onload = () => {
            lc.split = Split(['#left', '#right'])
            lc.editor = new lc.CodeMirrorEditor('editor', {
                doc: 'hello world',
                language: 'tsx'
            })
            lc.editor.on('change', lc.debounce(lc.handleChange, 500))
            lc.handleChange(lc.editor.state.doc.toString())
        }

        window.lc = lc

    })(window.LiveCode);
</script>

</body>
</html>

